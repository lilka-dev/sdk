on:
  release:
    types: [published]
  workflow_run:
    workflows: ["sdk"]
    types: [completed]
    branches: [main]

jobs:
  check-sdk-status:
    runs-on: ubuntu-latest
    if: github.event_name == 'release' || (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
    outputs:
      should-run: ${{ steps.check.outputs.should-run }}
    steps:
      - name: Check if workflow should run
        id: check
        run: |
          if [[ "${{ github.event_name }}" == "release" ]]; then
            echo "should-run=true" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event_name }}" == "workflow_run" && "${{ github.event.workflow_run.conclusion }}" == "success" ]]; then
            echo "should-run=true" >> $GITHUB_OUTPUT
          else
            echo "should-run=false" >> $GITHUB_OUTPUT
          fi

  update-version:
    needs: check-sdk-status
    if: needs.check-sdk-status.outputs.should-run == 'true'
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.extract.outputs.VERSION }}
      major: ${{ steps.extract.outputs.MAJOR }}
      minor: ${{ steps.extract.outputs.MINOR }}
      patch: ${{ steps.extract.outputs.PATCH }}
      tag: ${{ steps.extract.outputs.TAG }}
      type: ${{ steps.release.outputs.TYPE }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Extract version from tag
        id: extract
        run: |
          # Отримати тег без refs/tags/
          TAG="${GITHUB_REF#refs/tags/}"
          VERSION="${TAG#v}"

          # Розбити на major/minor/patch
          IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"

          echo "Extracted version: $VERSION"
          echo "MAJOR=$MAJOR" >> $GITHUB_OUTPUT
          echo "MINOR=$MINOR" >> $GITHUB_OUTPUT
          echo "PATCH=$PATCH" >> $GITHUB_OUTPUT
          echo "TAG=$TAG" >> $GITHUB_OUTPUT
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - name: Determine release type
        id: release
        run: |
          if [[ "${{ github.event_name }}" == "release" && "${{ github.event.release.prerelease }}" == "true" ]]; then
            echo "TYPE=SDK_VERSION_TYPE_PRE_RELEASE" >> $GITHUB_OUTPUT
          else
            echo "TYPE=SDK_VERSION_TYPE_RELEASE" >> $GITHUB_OUTPUT
          fi

      - name: Update library.json version
        run: |
          echo "Updating version to ${{ steps.extract.outputs.VERSION }}"
          sed -i 's/"version": "[^"]*"/"version": "${{ steps.extract.outputs.VERSION }}"/' lib/lilka/library.json
          cat lib/lilka/library.json

      - name: Generate sdk_version_auto_gen.h
        run: |
          cat > lib/lilka/src/lilka/sdk_version_auto_gen.h <<EOF
          #pragma once
          #ifndef VERSION_AUTO_GEN_H
          #define VERSION_AUTO_GEN_H
          #define SDK_VERSION_MAJOR ${{ steps.extract.outputs.MAJOR }}
          #define SDK_VERSION_MINOR ${{ steps.extract.outputs.MINOR }}
          #define SDK_VERSION_PATCH ${{ steps.extract.outputs.PATCH }}
          #define SDK_VERSION_TYPE  ${{ steps.release.outputs.TYPE }}
          #endif // VERSION_AUTO_GEN_H
          EOF
          cat lib/lilka/src/lilka/sdk_version_auto_gen.h

  publish-to-pio:
    needs: update-version
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'
      - name: Install PlatformIO
        run: |
          python -m pip install --upgrade pip
          pip install platformio
      - name: Update library.json version
        run: |
          echo "Updating version to ${{ needs.update-version.outputs.version }}"
          sed -i 's/"version": "[^"]*"/"version": "${{ needs.update-version.outputs.version }}"/' lib/lilka/library.json
          cat lib/lilka/library.json
      - name: Login to PlatformIO
        run: |
          pio account login -u "${{ secrets.PIO_USERNAME }}" -p "${{ secrets.PIO_PASSWORD }}"
      - name: Publish to PlatformIO Registry
        run: |
          cd lib/lilka
          pio pkg publish --non-interactive
          echo "Published to PlatformIO Registry"

  github-releases-to-discord:
    needs: update-version
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Update library.json version
        run: |
          echo "Updating version to ${{ needs.update-version.outputs.version }}"
          sed -i 's/"version": "[^"]*"/"version": "${{ needs.update-version.outputs.version }}"/' lib/lilka/library.json
      - name: Github Releases To Discord
        uses: SethCohen/github-releases-to-discord@v1.13.0
        with:
          webhook_url: ${{ secrets.WEBHOOK_URL }}
          color: "2105893"
          username: "Release Changelog SDK"
          avatar_url: "https://avatars.githubusercontent.com/u/213694258?s=48&v=4"
          content: "||@everyone||"
          footer_title: "Changelog"
          footer_icon_url: "https://avatars.githubusercontent.com/u/213694258?s=48&v=4"
          footer_timestamp: true